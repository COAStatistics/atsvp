upstream app3 {
    ip_hash;
    server fds:8000;
}


server {
    listen 8080;
    server_name fds.atri.org.tw;
    location / {
		#proxy_pass             http://app3;
        return 301 https://$host$request_uri;
    }
}

server {
    listen 8443 ssl http2;

    server_name  fds.atri.org.tw;
    # set crt and key
    ssl_certificate     /etc/letsencrypt/live/fds.atri.org.tw/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/fds.atri.org.tw/privkey.pem;
    
    ssl_session_cache shared:le_nginx_SSL:10m;
    ssl_session_timeout 1440m;
    ssl_session_tickets off;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;

    ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384";

    location /static/ {
        include     /etc/nginx/mime.types;
        default_type application/octet-stream;
        autoindex on;
        alias /app/static_files/statics/;
        add_header Cache-Control "public, max-age=604800";
    }

    location / {
                add_header X-Proxy-Cache    $upstream_cache_status;
                
                proxy_pass             http://app3;
                
                    proxy_set_header            Host $host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;

                proxy_connect_timeout       6000;
                proxy_send_timeout          6000;
                proxy_read_timeout          6000;
                proxy_buffer_size           4k;
                proxy_buffers               4 32k;
                proxy_busy_buffers_size     64k;
                proxy_temp_file_write_size  64k;
                send_timeout                6000;
                proxy_buffering             off;
    }
# Enable Gzip 
gzip on; 
gzip_http_version 1.0; 
gzip_comp_level 2; 
gzip_min_length 1100; 
gzip_buffers  4 8k; 
gzip_proxied any; 
gzip_types 
# text/html is always compressed by HttpGzipModule 
text/css 
text/javascript 
text/xml 
text/plain 
text/x-component 
application/javascript 
application/json 
application/xml 
application/rss+xml 
font/truetype 
font/opentype 
application/vnd.ms-fontobject 
image/svg+xml; 

gzip_static on; 
gzip_proxied  expired no-cache no-store private auth; 
gzip_disable  "MSIE [1-6]\."; 
gzip_vary   on;
}
